var __extends=this.__extends||function(t,e){function i(){this.constructor=t}for(var s in e)e.hasOwnProperty(s)&&(t[s]=e[s]);i.prototype=e.prototype,t.prototype=new i};define(["require","exports","./constants"],function(t,e,i){function s(t,e,i){var s=new a("world",e);s.load(t),i&&s.setSounds(i),s.start()}var o=(i.Direction,i.MarioState,i.SizeState,i.GroundBlocking,i.DeathMode,i.MushroomMode,i.setup),h=i.images;String.prototype.toUrl=function(){return"url("+this+")"},Math.sign=function(t){return t>0?1:0>t?-1:0};var n=function(){function t(t,e){"undefined"==typeof t&&(t=0),"undefined"==typeof e&&(e=0),this.setPosition(t,e),this.clearFrames(),this.frameCount=0}return t.prototype.setPosition=function(t,e){this.x=t,this.y=e},t.prototype.getPosition=function(){return{x:this.x,y:this.y}},t.prototype.setImage=function(t,e,i){this.image={path:t,x:e,y:i}},t.prototype.setSize=function(t,e){this.width=t,this.height=e},t.prototype.getSize=function(){return{width:this.width,height:this.height}},t.prototype.setupFrames=function(t,e,i,s){if(s){if(this.frameID===s)return!0;this.frameID=s}return this.currentFrame=0,this.frameTick=e?1e3/t/o.interval:0,this.frames=e,this.rewindFrames=i,!1},t.prototype.clearFrames=function(){this.frameID=void 0,this.frames=0,this.currentFrame=0,this.frameTick=0},t.prototype.playFrame=function(){if(this.frameTick&&this.view&&(this.frameCount++,this.frameCount>=this.frameTick)){this.frameCount=0,this.currentFrame===this.frames&&(this.currentFrame=0);var t=this.view;t.css("background-position","-"+(this.image.x+this.width*((this.rewindFrames?this.frames-1:0)-this.currentFrame))+"px -"+this.image.y+"px"),this.currentFrame++}},t}(),r=function(t){function e(e,i,s,o,h,n){t.call(this,0,0),this.view=$("#"+e),this.setSize(this.view.width(),this.view.height()),this.setImage(this.view.css("background-image"),i,s),this.setupFrames(o,h,n)}return __extends(e,t),e}(n),a=function(t){function e(e,i){this.world=$("#"+e),this.controls=i,this.nextCycles=0,t.call(this,0,0),this.active=!1,this.figures=[],this.obstacles=[],this.decorations=[],this.items=[],this.coinGauge=new r("coin",0,0,10,4,!0),this.liveGauge=new r("live",0,430,6,6,!0)}return __extends(e,t),e.prototype.reload=function(){var t={};this.pause();for(var e=this.figures.length;e--;)this.figures[e].store(t);if(t.lifes--,this.reset(),t.lifes<0)this.load(this.firstLevel());else{this.load(this.raw);for(var e=this.figures.length;e--;)this.figures[e].restore(t)}this.start()},e.prototype.nextLevel=function(){return this.raw},e.prototype.firstLevel=function(){return this.raw},e.prototype.load=function(t){this.active&&(this.loop&&this.pause(),this.reset()),this.setPosition(0,0),this.setSize(32*t.width,32*t.height),this.setBackground(t.background),this.raw=t,this.id=t.id,this.active=!0;for(var e=t.data,i=0;i<t.width;i++){for(var s=[],o=0;o<t.height;o++)s.push(void 0);this.obstacles.push(s)}for(var i=0,h=e.length;h>i;i++)for(var n=e[i],o=0,r=n.length;r>o;o++)fe[n[o]]&&new fe[n[o]](32*i,32*(r-o-1),this)},e.prototype.next=function(){this.nextCycles=Math.floor(7e3/o.interval)},e.prototype.nextLoad=function(){if(!this.nextCycles){var t={};this.pause();for(var e=this.figures.length;e--;)this.figures[e].store(t);this.reset(),this.load(this.nextLevel());for(var e=this.figures.length;e--;)this.figures[e].restore(t);this.start()}},e.prototype.getGridWidth=function(){return this.raw.width},e.prototype.getGridHeight=function(){return this.raw.height},e.prototype.setSounds=function(t){this.sounds=t},e.prototype.playSound=function(t){this.sounds&&this.sounds.play(t)},e.prototype.playMusic=function(t){this.sounds&&this.sounds.sideMusic(t)},e.prototype.reset=function(){this.active=!1,this.world.empty(),this.figures=[],this.obstacles=[],this.items=[],this.decorations=[]},e.prototype.tick=function(){if(this.nextCycles)return this.nextCycles--,void this.nextLoad();var t,e,i=0,s=0;for(i=this.figures.length;i--;){if(t=this.figures[i],t.dead)if(t.death())t.playFrame();else{if(t instanceof oe)return this.reload();t.view.remove(),this.figures.splice(i,1)}else if(i)for(s=i;s--&&!t.dead;)e=this.figures[s],!e.dead&&t.q2q(e)&&(t.hit(e),e.hit(t));t.dead||(t.move(),t.playFrame())}for(i=this.items.length;i--;)this.items[i].playFrame();this.coinGauge.playFrame(),this.liveGauge.playFrame()},e.prototype.start=function(){var t=this;this.controls.bind(),this.loop=setInterval(function(){return t.tick()},o.interval)},e.prototype.pause=function(){this.controls.unbind(),clearInterval(this.loop),this.loop=void 0},e.prototype.setPosition=function(e,i){t.prototype.setPosition.call(this,e,i),this.world.css("left",-e)},e.prototype.setBackground=function(t){var e=i.basepath+"backgrounds/"+((10>t?"0":"")+t)+".png";this.world.parent().css({backgroundImage:e.toUrl(),backgroundPosition:"0 -380px"}),this.setImage(e,0,0)},e.prototype.setSize=function(e,i){t.prototype.setSize.call(this,e,i)},e.prototype.setParallax=function(t){this.setPosition(t,this.y),this.world.parent().css("background-position","-"+Math.floor(t/3)+"px -380px")},e}(n),c=function(t){function e(e,i,s,o){this.blocking=s,this.view=$("<div />").addClass("matter").appendTo(o.world),this.level=o,t.call(this,e,i),this.setSize(32,32),this.addToGrid(o)}return __extends(e,t),e.prototype.addToGrid=function(t){t.obstacles[this.x/32][this.level.getGridHeight()-1-this.y/32]=this},e.prototype.setImage=function(e,i,s){"undefined"==typeof i&&(i=0),"undefined"==typeof s&&(s=0),this.view.css({backgroundImage:e?e.toUrl():"none",backgroundPosition:"-"+i+"px -"+s+"px"}),t.prototype.setImage.call(this,e,i,s)},e.prototype.setPosition=function(e,i){this.view.css({left:e,bottom:i}),t.prototype.setPosition.call(this,e,i)},e}(n),l=function(t){function e(e,i,s){this.view=$("<div />").addClass("figure").appendTo(s.world),this.dx=0,this.dy=0,this.dead=!1,this.onground=!0,this.setState(1),this.setVelocity(0,0),this.direction=0,this.level=s,t.call(this,e,i),s.figures.push(this)}return __extends(e,t),e.prototype.q2q=function(t){return this.x>t.x+16?!1:this.x+16<t.x?!1:this.y+32*this.state-4<t.y?!1:this.y+4>t.y+32*t.state?!1:!0},e.prototype.setState=function(t){this.state=t},e.prototype.hurt=function(){},e.prototype.store=function(){},e.prototype.restore=function(){},e.prototype.setImage=function(e,i,s){"undefined"==typeof i&&(i=0),"undefined"==typeof s&&(s=0),this.view.css({backgroundImage:e?e.toUrl():"none",backgroundPosition:"-"+i+"px -"+s+"px"}),t.prototype.setImage.call(this,e,i,s)},e.prototype.setOffset=function(t,e){this.dx=t,this.dy=e,this.setPosition(this.x,this.y)},e.prototype.setPosition=function(e,i){this.view.css({left:e,bottom:i,marginLeft:this.dx,marginBottom:this.dy}),t.prototype.setPosition.call(this,e,i),this.setGridPosition(e,i)},e.prototype.setSize=function(e,i){this.view.css({width:e,height:i}),t.prototype.setSize.call(this,e,i)},e.prototype.setGridPosition=function(t,e){this.i=Math.floor((t+16)/32),this.j=Math.ceil(this.level.getGridHeight()-1-e/32),this.j>this.level.getGridHeight()&&this.die()},e.prototype.getGridPosition=function(){return{i:this.i,j:this.j}},e.prototype.setVelocity=function(t,e){this.vx=t,this.vy=e,t>0?this.direction=3:0>t&&(this.direction=1)},e.prototype.getVelocity=function(){return{vx:this.vx,vy:this.vy}},e.prototype.hit=function(){},e.prototype.trigger=function(){},e.prototype.collides=function(t,e,i,s,o){if(0>t||e>=this.level.obstacles.length)return!0;if(0>i||s>=this.level.getGridHeight())return!1;for(var h=t;e>=h;h++)for(var n=s;n>=i;n--){var r=this.level.obstacles[h][n];if(r&&(r instanceof N&&(8===o||0===r.blocking)&&this.trigger(r),(r.blocking&o)===o))return!0}return!1},e.prototype.move=function(){var t=this.vx,e=this.vy-o.gravity,i=this.state,s=this.x,h=this.y,n=Math.sign(t),r=Math.sign(e),a=this.i,c=a,l=Math.ceil(this.level.getGridHeight()-i-(h+31)/32),u=this.j,p=0,d=0,f=!1,y=Math.floor((s+16+t)/32);n>0?(p=y-c,y=c,d=1):0>n&&(p=a-y,y=a,d=4),s+=t;for(var m=0;p>m;m++){if(this.collides(y+n,y+n,l,u,d)){t=0,s=32*y+15*n;break}y+=n,a+=n,c+=n}r>0?(y=Math.ceil(this.level.getGridHeight()-i-(h+31+e)/32),p=l-y,y=l,d=8):0>r?(y=Math.ceil(this.level.getGridHeight()-1-(h+e)/32),p=y-u,y=u,d=2):p=0,h+=e;for(var m=0;p>m;m++){if(this.collides(a,c,y-r,y-r,d)){f=0>r,e=0,h=this.level.height-32*(y+1)-(r>0?32*(i-1):0);break}y-=r}this.onground=f,this.setVelocity(t,e),this.setPosition(s,h)},e.prototype.death=function(){return!1},e.prototype.die=function(){this.dead=!0},e}(n),u=function(t){function e(e,i,s){t.call(this,e,i,s)}return __extends(e,t),e}(l),p=function(t){function e(e,i,s,o){t.call(this,e,i,s,o)}return __extends(e,t),e}(c),d=function(t){function e(e,i,s){var o=2;t.call(this,e,i,o,s),this.setImage(h.objects,888,404)}return __extends(e,t),e}(p),f=function(t){function e(e,i,s){var o=6;t.call(this,e,i,o,s),this.setImage(h.objects,922,404)}return __extends(e,t),e}(p),y=function(t){function e(e,i,s){var o=3;t.call(this,e,i,o,s),this.setImage(h.objects,854,404)}return __extends(e,t),e}(p),m=function(t){function e(e,i,s){var o=4;t.call(this,e,i,o,s),this.setImage(h.objects,922,438)}return __extends(e,t),e}(p),v=function(t){function e(e,i,s){var o=1;t.call(this,e,i,o,s),this.setImage(h.objects,854,438)}return __extends(e,t),e}(p),g=function(t){function e(e,i,s){var o=2;t.call(this,e,i,o,s),this.setImage(h.objects,922,506)}return __extends(e,t),e}(p),_=function(t){function e(e,i,s){var o=2;t.call(this,e,i,o,s),this.setImage(h.objects,854,506)}return __extends(e,t),e}(p),x=function(t){function e(e,i,s){var o=15;t.call(this,e,i,o,s),this.setImage(h.objects,550,160)}return __extends(e,t),e}(p),b=function(t){function e(e,i,s){var o=15;t.call(this,e,i,o,s),this.setImage(h.objects,514,194)}return __extends(e,t),e}(p),w=function(t){function e(e,i,s){var o=15;t.call(this,e,i,o,s),this.setImage(h.objects,36,358)}return __extends(e,t),e}(p),S=function(t){function e(e,i,s){var o=15;t.call(this,e,i,o,s),this.setImage(h.objects,2,358)}return __extends(e,t),e}(p),I=function(t){function e(e,i,s){var o=12;t.call(this,e,i,o,s),this.setImage(h.objects,36,390)}return __extends(e,t),e}(p),F=function(t){function e(e,i,s){var o=9;t.call(this,e,i,o,s),this.setImage(h.objects,2,390)}return __extends(e,t),e}(p),k=function(t){function e(e,i,s){t.call(this,e,i,0,s),s.decorations.push(this)}return __extends(e,t),e.prototype.setImage=function(e,i,s){"undefined"==typeof i&&(i=0),"undefined"==typeof s&&(s=0),this.view.css({backgroundImage:e?e.toUrl():"none",backgroundPosition:"-"+i+"px -"+s+"px"}),t.prototype.setImage.call(this,e,i,s)},e.prototype.setPosition=function(e,i){this.view.css({left:e,bottom:i}),t.prototype.setPosition.call(this,e,i)},e}(c),M=function(t){function e(e,i,s){t.call(this,e,i,s),this.setImage(h.objects,612,868)}return __extends(e,t),e}(k),j=function(t){function e(e,i,s){t.call(this,e,i,s),this.setImage(h.objects,648,868)}return __extends(e,t),e}(k),D=function(t){function e(e,i,s){t.call(this,e,i,s),this.setImage(h.objects,888,438)}return __extends(e,t),e}(k),C=function(t){function e(e,i,s){t.call(this,e,i,s),this.setImage(h.objects,922,540)}return __extends(e,t),e}(k),P=function(t){function e(e,i,s){t.call(this,e,i,s),this.setImage(h.objects,854,540)}return __extends(e,t),e}(k),V=function(t){function e(e,i,s){t.call(this,e,i,s),this.setImage(h.objects,382,928)}return __extends(e,t),e}(k),G=function(t){function e(e,i,s){t.call(this,e,i,s),this.setImage(h.objects,314,928)}return __extends(e,t),e}(k),z=function(t){function e(e,i,s){t.call(this,e,i,s),this.setImage(h.objects,348,928)}return __extends(e,t),e}(k),L=function(t){function e(e,i,s){t.call(this,e,i,s),this.setImage(h.objects,212,928)}return __extends(e,t),e}(k),B=function(t){function e(e,i,s){t.call(this,e,i,s),this.setImage(h.objects,178,928)}return __extends(e,t),e}(k),W=function(t){function e(e,i,s){t.call(this,e,i,s),this.setImage(h.objects,990,506)}return __extends(e,t),e}(k),U=function(t){function e(e,i,s){t.call(this,e,i,s),this.setImage(h.objects,956,506)}return __extends(e,t),e}(k),T=function(t){function e(e,i,s){t.call(this,e,i,s),this.setImage(h.objects,782,832)}return __extends(e,t),e}(k),H=function(t){function e(e,i,s){t.call(this,e,i,s),this.setImage(h.objects,748,832)}return __extends(e,t),e}(k),E=function(t){function e(e,i,s){t.call(this,e,i,s),this.setImage(h.objects,714,832)}return __extends(e,t),e}(k),q=function(t){function e(e,i,s){t.call(this,e,i,s),this.setImage(h.objects,36,424)}return __extends(e,t),e}(k),R=function(t){function e(e,i,s){t.call(this,e,i,s),this.setImage(h.objects,2,424)}return __extends(e,t),e}(k),A=function(t){function e(e,i,s){t.call(this,e,i,s),this.setImage(h.objects,36,458)}return __extends(e,t),e}(k),O=function(t){function e(e,i,s){t.call(this,e,i,s),this.setImage(h.objects,2,458)}return __extends(e,t),e}(k),N=function(t){function e(e,i,s,h){this.isBouncing=!1,this.bounceCount=0,this.bounceFrames=Math.floor(50/o.interval),this.bounceStep=Math.ceil(10/this.bounceFrames),this.bounceDir=1,this.isBlocking=s,t.call(this,e,i,s?15:0,h),this.activated=!1,this.addToLevel(h)}return __extends(e,t),e.prototype.addToLevel=function(t){t.items.push(this)},e.prototype.activate=function(){this.activated=!0},e.prototype.bounce=function(){this.isBouncing=!0;for(var t=this.level.figures.length;t--;){var e=this.level.figures[t];e.y===this.y+32&&e.x>=this.x-16&&e.x<=this.x+16&&(e instanceof u?e.setVelocity(e.vx,o.bounce):e.die())}},e.prototype.playFrame=function(){this.isBouncing&&(this.view.css({bottom:(this.bounceDir>0?"+":"-")+"="+this.bounceStep+"px"}),this.bounceCount+=this.bounceDir,this.bounceCount===this.bounceFrames?this.bounceDir=-1:0===this.bounceCount&&(this.bounceDir=1,this.isBouncing=!1)),t.prototype.playFrame.call(this)},e}(c),J=function(t){function e(e,i,s){t.call(this,e,i,!1,s),this.setImage(h.objects,0,0),this.setupFrames(10,4,!0)}return __extends(e,t),e.prototype.activate=function(e){this.activated||(this.level.playSound("coin"),e.addCoin(),this.remove()),t.prototype.activate.call(this,e)},e.prototype.remove=function(){this.view.remove()},e}(N),K=function(t){function e(e,i,s){t.call(this,e,i,s),this.setImage(h.objects,96,0),this.clearFrames(),this.view.hide(),this.count=0,this.frames=Math.floor(150/o.interval),this.step=Math.ceil(30/this.frames)}return __extends(e,t),e.prototype.remove=function(){},e.prototype.addToGrid=function(){},e.prototype.addToLevel=function(){},e.prototype.activate=function(e){t.prototype.activate.call(this,e),this.view.show().css({bottom:"+=8px"})},e.prototype.act=function(){return this.view.css({bottom:"+="+this.step+"px"}),this.count++,this.count===this.frames},e}(J),Q=function(t){function e(e,i,s,o){"undefined"==typeof o&&(o=1),t.call(this,e,i,!0,s),this.setImage(h.objects,346,328),this.setAmount(o)}return __extends(e,t),e.prototype.setAmount=function(t){this.items=[],this.actors=[];for(var e=0;t>e;e++)this.items.push(new K(this.x,this.y,this.level))},e.prototype.activate=function(e){if(!this.isBouncing&&this.items.length){this.bounce();var i=this.items.pop();i.activate(e),this.actors.push(i),this.items.length||this.setImage(h.objects,514,194)}t.prototype.activate.call(this,e)},e.prototype.playFrame=function(){for(var e=this.actors.length;e--;)this.actors[e].act()&&(this.actors[e].view.remove(),this.actors.splice(e,1));t.prototype.playFrame.call(this)},e}(N),X=function(t){function e(e,i,s){t.call(this,e,i,s,8)}return __extends(e,t),e}(Q),Y=function(t){function e(e,i,s){t.call(this,e,i,!0,s),this.setImage(h.objects,96,33),this.star=new Z(e,i,s),this.setupFrames(8,4,!1)}return __extends(e,t),e.prototype.activate=function(e){this.activated||(this.star.release(),this.clearFrames(),this.bounce(),this.setImage(h.objects,514,194)),t.prototype.activate.call(this,e)},e}(N),Z=function(t){function e(e,i,s){t.call(this,e,i+32,s),this.active=!1,this.setSize(32,32),this.setImage(h.objects,32,69),this.view.hide()}return __extends(e,t),e.prototype.release=function(){this.taken=4,this.active=!0,this.level.playSound("mushroom"),this.view.show(),this.setVelocity(o.star_vx,o.star_vy),this.setupFrames(10,2,!1)},e.prototype.collides=function(){return!1},e.prototype.move=function(){this.active&&(this.vy+=this.vy<=-o.star_vy?o.gravity:o.gravity/2,t.prototype.move.call(this)),this.taken&&this.taken--},e.prototype.hit=function(t){!this.taken&&this.active&&t instanceof oe&&(t.invincible(),this.die())},e}(u),te=function(t){function e(e,i,s){t.call(this,e,i,!0,s),this.setImage(h.objects,96,33),this.max_mode=1,this.mushroom=new ee(e,i,s),this.setupFrames(8,4,!1)}return __extends(e,t),e.prototype.activate=function(e){this.activated||(this.mushroom.release(1===e.state||0===this.max_mode?0:1),this.clearFrames(),this.bounce(),this.setImage(h.objects,514,194)),t.prototype.activate.call(this,e)},e}(N),ee=function(t){function e(e,i,s){t.call(this,e,i,s),this.active=!1,this.setSize(32,32),this.setImage(h.objects,582,60),this.released=0,this.view.css("z-index",94).hide()}return __extends(e,t),e.prototype.release=function(t){this.released=4,this.level.playSound("mushroom"),1===t&&this.setImage(h.objects,548,60),this.mode=t,this.view.show()},e.prototype.move=function(){this.active?(t.prototype.move.call(this),0===this.mode&&0===this.vx&&this.setVelocity(3===this.direction?-o.mushroom_v:o.mushroom_v,this.vy)):this.released&&(this.released--,this.setPosition(this.x,this.y+8),this.released||(this.active=!0,this.view.css("z-index",99),0===this.mode&&this.setVelocity(o.mushroom_v,o.gravity)))},e.prototype.hit=function(t){this.active&&t instanceof oe&&(t.upgrade(this.mode),this.die())},e}(u),ie=function(t){function e(e,i,s){t.call(this,e,i,s)}return __extends(e,t),e}(l),se=function(t){function e(e){t.call(this,e.x+31,e.y+14,e.level),this.parent=e,this.setImage(h.sprites,191,366),this.setSize(16,16),this.direction=e.direction,this.vy=0,this.life=Math.ceil(2e3/o.interval),this.speed=o.bullet_v,this.vx=3===this.direction?this.speed:-this.speed}return __extends(e,t),e.prototype.setVelocity=function(e,i){if(t.prototype.setVelocity.call(this,e,i),0===this.vx){var s=this.speed*Math.sign(this.speed);this.vx=3===this.direction?-s:s}this.onground&&(this.vy=o.bounce)},e.prototype.move=function(){--this.life?t.prototype.move.call(this):this.die()},e.prototype.hit=function(t){t!==this.parent&&(t.die(),this.die())},e}(l),oe=function(t){function e(e,i,s){this.standSprites=[[[{x:0,y:81},{x:481,y:83}],[{x:81,y:0},{x:561,y:83}]],[[{x:0,y:162},{x:481,y:247}],[{x:81,y:243},{x:561,y:247}]]],this.crouchSprites=[[{x:241,y:0},{x:161,y:0}],[{x:241,y:162},{x:241,y:243}]],this.deadly=0,this.invulnerable=0,this.width=80,t.call(this,e,i,s),this.blinking=0,this.setOffset(-24,0),this.setSize(80,80),this.cooldown=0,this.setMarioState(0),this.setLifes(o.start_lives),this.setCoins(0),this.deathCount=0,this.deathBeginWait=Math.floor(700/o.interval),this.deathEndWait=0,this.deathFrames=Math.floor(600/o.interval),this.deathStepUp=Math.ceil(200/this.deathFrames),this.deathDir=1,this.direction=3,this.setImage(h.sprites,81,0),this.crouching=!1,this.fast=!1}return __extends(e,t),e.prototype.setMarioState=function(t){this.marioState=t},e.prototype.store=function(t){t.lifes=this.lifes,t.coins=this.coins,t.state=this.state,t.marioState=this.marioState},e.prototype.restore=function(t){this.setLifes(t.lifes||0),this.setCoins(t.coins||0),this.setState(t.state||1),this.setMarioState(t.marioState||0)},e.prototype.setState=function(e){e!==this.state&&(this.setMarioState(0),t.prototype.setState.call(this,e))},e.prototype.setPosition=function(e,i){t.prototype.setPosition.call(this,e,i);var s=this.level.width-640,o=this.x<=210?0:this.x>=this.level.width-230?s:s/(this.level.width-440)*(this.x-210);this.level.setParallax(o),this.onground&&this.x>=this.level.width-128&&this.victory()},e.prototype.trigger=function(t){t.activate(this)},e.prototype.input=function(t){this.fast=t.accelerate,this.crouching=t.down,this.crouching||(this.onground&&t.up&&this.jump(),t.accelerate&&1===this.marioState&&this.shoot(),t.right||t.left?this.walk(t.left,t.accelerate):this.vx=0)},e.prototype.victory=function(){this.level.playMusic("success"),this.clearFrames(),this.view.show(),this.setImage(h.sprites,1===this.state?241:161,81),this.level.next()},e.prototype.shoot=function(){this.cooldown||(this.cooldown=o.cooldown,this.level.playSound("shoot"),new se(this))},e.prototype.setVelocity=function(e,i){this.crouching?(e=0,this.crouch()):this.onground&&e>0?this.walkRight():this.onground&&0>e?this.walkLeft():this.stand(),t.prototype.setVelocity.call(this,e,i)},e.prototype.blink=function(t){this.blinking=Math.max(2*t*o.blinkfactor,this.blinking)},e.prototype.invincible=function(){this.level.playMusic("invincibility"),this.deadly=Math.floor(o.invincible/o.interval),this.invulnerable=this.deadly,this.blink(Math.ceil(this.deadly/(2*o.blinkfactor)))},e.prototype.upgrade=function(t){0===t?this.grow():1===t&&this.shooter()},e.prototype.grow=function(){1===this.state&&(this.level.playSound("grow"),this.setState(2),this.blink(3))},e.prototype.shooter=function(){1===this.state?this.grow():this.level.playSound("grow"),this.setMarioState(1)},e.prototype.walk=function(t,e){this.vx=o.walking_v*(e?2:1)*(t?-1:1)},e.prototype.walkRight=function(){1===this.state?this.setupFrames(8,2,!0,"WalkRightSmall")||this.setImage(h.sprites,0,0):this.setupFrames(9,2,!0,"WalkRightBig")||this.setImage(h.sprites,0,243)},e.prototype.walkLeft=function(){1===this.state?this.setupFrames(8,2,!1,"WalkLeftSmall")||this.setImage(h.sprites,80,81):this.setupFrames(9,2,!1,"WalkLeftBig")||this.setImage(h.sprites,81,162)},e.prototype.stand=function(){var t=this.standSprites[this.state-1][1===this.direction?0:1][this.onground?0:1];this.setImage(h.sprites,t.x,t.y),this.clearFrames()},e.prototype.crouch=function(){var t=this.crouchSprites[this.state-1][1===this.direction?0:1];this.setImage(h.sprites,t.x,t.y),this.clearFrames()},e.prototype.jump=function(){this.level.playSound("jump"),this.vy=o.jumping_v},e.prototype.move=function(){this.input(this.level.controls),t.prototype.move.call(this)},e.prototype.addCoin=function(){this.setCoins(this.coins+1)},e.prototype.playFrame=function(){this.blinking&&(this.blinking%o.blinkfactor===0&&this.view.toggle(),this.blinking--),this.cooldown&&this.cooldown--,this.deadly&&this.deadly--,this.invulnerable&&this.invulnerable--,t.prototype.playFrame.call(this)},e.prototype.setCoins=function(t){this.coins=t,this.coins>=o.max_coins&&(this.addLife(),this.coins-=o.max_coins),this.level.world.parent().children("#coinNumber").text(this.coins)},e.prototype.addLife=function(){this.level.playSound("liveupgrade"),this.setLifes(this.lifes+1)},e.prototype.setLifes=function(t){this.lifes=t,this.level.world.parent().children("#liveNumber").text(this.lifes)},e.prototype.death=function(){return this.deathBeginWait?(this.deathBeginWait--,!0):this.deathEndWait?!!--this.deathEndWait:(this.view.css({bottom:(this.deathDir>0?"+":"-")+"="+(this.deathDir>0?this.deathStepUp:this.deathStepDown)+"px"}),this.deathCount+=this.deathDir,this.deathCount===this.deathFrames?this.deathDir=-1:0===this.deathCount&&(this.deathEndWait=Math.floor(1800/o.interval)),!0)},e.prototype.die=function(){this.setMarioState(0),this.deathStepDown=Math.ceil(240/this.deathFrames),this.setupFrames(9,2,!1),this.setImage(h.sprites,81,324),this.level.playMusic("die"),t.prototype.die.call(this)},e.prototype.hurt=function(t){if(this.deadly)t.die();else{if(this.invulnerable)return;1===this.state?this.die():(this.invulnerable=Math.floor(o.invulnerable/o.interval),this.blink(Math.ceil(this.invulnerable/(2*o.blinkfactor))),this.setState(1),this.level.playSound("hurt"))}},e}(ie),he=function(t){function e(e,i,s){t.call(this,e,i,s),this.speed=0,this.deathMode=0,this.deathCount=0}return __extends(e,t),e.prototype.hide=function(){this.invisible=!0,this.view.hide()},e.prototype.show=function(){this.invisible=!1,this.view.show()},e.prototype.move=function(){if(!this.invisible&&(t.prototype.move.call(this),0===this.vx)){var e=this.speed*Math.sign(this.speed);this.setVelocity(3===this.direction?-e:e,this.vy)}},e.prototype.collides=function(e,i,s,o,h){if(this.j+1<this.level.getGridHeight())for(var n=e;i>=n;n++){if(0>n||n>=this.level.getGridWidth())return!0;var r=this.level.obstacles[n][this.j+1];if(!r||2!==(2&r.blocking))return!0}return t.prototype.collides.call(this,e,i,s,o,h)},e.prototype.setSpeed=function(t){this.speed=t,this.setVelocity(-t,0)},e.prototype.hurt=function(t){t instanceof re&&(this.deathMode=1),this.die()},e.prototype.hit=function(t){this.invisible||t instanceof oe&&(t.vy<0&&t.y-t.vy>=this.y+32*this.state?(t.setVelocity(t.vx,o.bounce),this.hurt(t)):t.hurt(this))},e}(l),ne=function(t){function e(e,i,s){t.call(this,e,i,s),this.setSize(34,32),this.setSpeed(o.ballmonster_v)}return __extends(e,t),e.prototype.setVelocity=function(e,i){t.prototype.setVelocity.call(this,e,i),1===this.direction?this.setupFrames(6,2,!1,"LeftWalk")||this.setImage(h.enemies,34,188):this.setupFrames(6,2,!0,"RightWalk")||this.setImage(h.enemies,0,228)},e.prototype.death=function(){if(0===this.deathMode)return!!--this.deathCount;if(this.view.css({bottom:(this.deathDir>0?"+":"-")+"="+this.deathStep+"px"}),this.deathCount+=this.deathDir,this.deathCount===this.deathFrames)this.deathDir=-1;else if(0===this.deathCount)return!1;return!0},e.prototype.die=function(){this.clearFrames(),0===this.deathMode?(this.level.playSound("enemy_die"),this.setImage(h.enemies,102,228),this.deathCount=Math.ceil(600/o.interval)):1===this.deathMode&&(this.level.playSound("shell"),this.setImage(h.enemies,68,3===this.direction?228:188),this.deathFrames=Math.floor(250/o.interval),this.deathDir=1,this.deathStep=Math.ceil(150/this.deathFrames)),t.prototype.die.call(this)},e}(he),re=function(t){function e(e,i,s){t.call(this,e,i,s),this.setSize(34,32),this.speed=0,this.setImage(h.enemies,0,494)}return __extends(e,t),e.prototype.activate=function(t,e){this.setupFrames(6,4,!1),this.setPosition(t,e),this.show()},e.prototype.takeBack=function(t){t.setShell(this)&&this.clearFrames()},e.prototype.hit=function(t){this.invisible||(this.vx?this.idle?this.idle--:t.hurt(this):t instanceof oe?(this.setSpeed(3===t.direction?-o.shell_v:o.shell_v),t.setVelocity(t.vx,o.bounce),this.idle=2):t instanceof ce&&1===t.state&&this.takeBack(t))},e.prototype.collides=function(t,e,i,s,o){if(0>t||e>=this.level.obstacles.length)return!0;if(0>i||s>=this.level.getGridHeight())return!1;for(var h=t;e>=h;h++)for(var n=s;n>=i;n--){var r=this.level.obstacles[h][n];if(r&&(r.blocking&o)===o)return!0}return!1},e}(he),ae=function(t){function e(e,i,s){t.call(this,e,i,s)}return __extends(e,t),e.prototype.setShell=function(){return!1},e}(he),ce=function(t){function e(e,i,s){this.walkSprites=[[{x:34,y:382},{x:0,y:437}],[{x:34,y:266},{x:0,y:325}]],t.call(this,e,i,s),this.wait=0,this.deathMode=0,this.deathFrames=Math.floor(250/o.interval),this.deathStepUp=Math.ceil(150/this.deathFrames),this.deathStepDown=Math.ceil(182/this.deathFrames),this.deathDir=1,this.deathCount=0,this.setSize(34,54),this.setShell(new re(e,i,s))}return __extends(e,t),e.prototype.setShell=function(t){return this.shell||this.wait?!1:(this.shell=t,t.hide(),this.setState(2),!0)},e.prototype.setState=function(e){t.prototype.setState.call(this,e),this.setSpeed(2===e?o.big_turtle_v:o.small_turtle_v)},e.prototype.setVelocity=function(e,i){t.prototype.setVelocity.call(this,e,i);var s=3===this.direction,o=this.walkSprites[this.state-1][s?1:0],n=Math.sign(e)+"-"+this.state;this.setupFrames(6,2,s,n)||this.setImage(h.enemies,o.x,o.y)},e.prototype.die=function(){t.prototype.die.call(this),this.clearFrames(),0===this.deathMode?(this.deathFrames=Math.floor(600/o.interval),this.setImage(h.enemies,102,437)):1===this.deathMode&&(this.level.playSound("shell"),this.setImage(h.enemies,68,1===this.state?3===this.direction?437:382:325))},e.prototype.death=function(){if(0===this.deathMode)return!!--this.deathFrames;if(this.view.css({bottom:(this.deathDir>0?"+":"-")+"="+(this.deathDir>0?this.deathStepUp:this.deathStepDown)+"px"}),this.deathCount+=this.deathDir,this.deathCount===this.deathFrames)this.deathDir=-1;else if(0===this.deathCount)return!1;return!0},e.prototype.move=function(){this.wait&&this.wait--,t.prototype.move.call(this)},e.prototype.hurt=function(){return this.level.playSound("enemy_die"),1===this.state?this.die():(this.wait=o.shell_wait,this.setState(1),this.shell.activate(this.x,this.y),void(this.shell=void 0))},e}(ae),le=function(t){function e(e,i,s){t.call(this,e,i,s),this.setSize(34,32),this.setSpeed(o.spiked_turtle_v),this.deathFrames=Math.floor(250/o.interval),this.deathStepUp=Math.ceil(150/this.deathFrames),this.deathStepDown=Math.ceil(182/this.deathFrames),this.deathDir=1,this.deathCount=0}return __extends(e,t),e.prototype.setVelocity=function(e,i){t.prototype.setVelocity.call(this,e,i),1===this.direction?this.setupFrames(4,2,!0,"LeftWalk")||this.setImage(h.enemies,0,106):this.setupFrames(6,2,!1,"RightWalk")||this.setImage(h.enemies,34,147)},e.prototype.death=function(){if(this.view.css({bottom:(this.deathDir>0?"+":"-")+"="+(this.deathDir>0?this.deathStepUp:this.deathStepDown)+"px"}),this.deathCount+=this.deathDir,this.deathCount===this.deathFrames)this.deathDir=-1;else if(0===this.deathCount)return!1;return!0},e.prototype.die=function(){this.level.playSound("shell"),this.clearFrames(),t.prototype.die.call(this),this.setImage(h.enemies,68,1===this.direction?106:147)},e.prototype.hit=function(t){this.invisible||t instanceof oe&&t.hurt(this)},e}(ae),ue=function(t){function e(e,i,s){t.call(this,e,i,s),this.setSize(34,42),this.setupFrames(5,2,!0),this.setImage(h.enemies,0,3)}return __extends(e,t),e.prototype.setVelocity=function(){t.prototype.setVelocity.call(this,0,0)},e.prototype.die=function(){this.level.playSound("shell"),this.clearFrames(),t.prototype.die.call(this)},e.prototype.hit=function(t){this.invisible||t instanceof oe&&t.hurt(this)},e}(he),pe=function(t){function e(e,i,s){t.call(this,e,i,s),this.deathFrames=Math.floor(250/o.interval),this.deathStepUp=Math.ceil(100/this.deathFrames),this.deathStepDown=Math.ceil(132/this.deathFrames),this.deathDir=1,this.deathCount=0}return __extends(e,t),e.prototype.die=function(){t.prototype.die.call(this),this.setImage(h.enemies,68,3)},e.prototype.death=function(){if(this.view.css({bottom:(this.deathDir>0?"+":"-")+"="+(this.deathDir>0?this.deathStepUp:this.deathStepDown)+"px"}),this.deathCount+=this.deathDir,this.deathCount===this.deathFrames)this.deathDir=-1;else if(0===this.deathCount)return!1;return!0},e}(ue),de=function(t){function e(e,i,s){this.bottom=i-48,this.top=i-6,t.call(this,e+16,i-6,s),this.setDirection(4),this.setImage(h.enemies,0,56),this.deathFrames=Math.floor(250/o.interval),this.deathFramesExtended=6,this.deathFramesExtendedActive=!1,this.deathStep=Math.ceil(100/this.deathFrames),this.deathDir=1,this.deathCount=0,this.view.css("z-index",95)}return __extends(e,t),e.prototype.setDirection=function(t){this.direction=t},e.prototype.setPosition=function(e,i){(i===this.bottom||i===this.top)&&(this.minimum=o.pipeplant_count,this.setDirection(2===this.direction?4:2)),t.prototype.setPosition.call(this,e,i)},e.prototype.blocked=function(){if(this.y===this.bottom){var t=!1;this.y+=48;for(var e=this.level.figures.length;e--;)if(this.level.figures[e]!=this&&this.q2q(this.level.figures[e])){t=!0;break}return this.y-=48,t}return!1},e.prototype.move=function(){0===this.minimum?this.blocked()||this.setPosition(this.x,this.y-(this.direction-3)*o.pipeplant_v):this.minimum--},e.prototype.die=function(){t.prototype.die.call(this),this.setImage(h.enemies,68,56)},e.prototype.death=function(){return this.deathFramesExtendedActive?(this.setPosition(this.x,this.y-8),!!--this.deathFramesExtended):(this.view.css({bottom:(this.deathDir>0?"+":"-")+"="+this.deathStep+"px"}),this.deathCount+=this.deathDir,this.deathCount===this.deathFrames?this.deathDir=-1:0===this.deathCount&&(this.deathFramesExtendedActive=!0),!0)},e}(ue),fe={pipeplant:de,staticplant:pe,greenturtle:ce,spikedturtle:le,shell:re,ballmonster:ne,mario:oe,pipe_right_grass:q,pipe_left_grass:R,pipe_right_soil:A,pipe_left_soil:O,planted_soil_left:E,planted_soil_middle:H,planted_soil_right:T,grass_top_right_rounded_soil:W,grass_top_left_rounded_soil:U,bush_right:V,bush_middle_right:G,bush_middle:z,bush_middle_left:L,bush_left:B,soil:D,soil_right:C,soil_left:P,grass_top:d,grass_top_right:f,grass_top_left:y,grass_right:m,grass_left:v,grass_top_right_rounded:g,grass_top_left_rounded:_,stone:x,brown_block:b,pipe_top_right:w,pipe_top_left:S,pipe_right:I,pipe_left:F,grass_top_right_corner:M,grass_top_left_corner:j,coin:J,coinbox:Q,multiple_coinbox:X,starbox:Y,mushroombox:te};
e.run=s});